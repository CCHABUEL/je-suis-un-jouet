<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>JeSuisUnJouet</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <!-- Eruda pour le debug mobile -->
    <script src="https://cdn.jsdelivr.net/npm/eruda"></script>
    <script>eruda.init();</script>

    <script type="importmap">
      {
        "imports": {
          "@google/generative-ai": "https://esm.run/@google/generative-ai"
        }
      }
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@300;400;600&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Fredoka', sans-serif;
            background-color: #fdf6e3;
            overscroll-behavior-y: none;
        }
        
        .toy-card {
            background: white;
            border-radius: 1rem;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .card-image-wrapper {
            position: relative;
            width: 100%;
            padding-top: 100%; /* Ratio 1:1 */
            background: #f3f4f6;
        }

        .card-image-content {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .card-image-content img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #ff6b6b;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="text-gray-800 min-h-screen pb-10">

    <!-- Modal Clé API -->
    <div id="apiKeyModal" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 hidden p-6">
        <div class="bg-white p-6 rounded-2xl w-full max-w-sm border-4 border-yellow-400 relative shadow-2xl">
            <button onclick="document.getElementById('apiKeyModal').classList.add('hidden')" class="absolute top-2 right-2 text-gray-400 p-2">
                <i class="fas fa-times text-xl"></i>
            </button>
            <h3 class="text-xl font-bold mb-4 text-center text-yellow-500">Clé API Requise</h3>
            <div class="mb-4">
                <p class="text-sm text-gray-600 mb-2">Collez votre clé Google AI ci-dessous (commence par "Alza...").</p>
                <input type="password" id="userApiKey" placeholder="AlzaSy..." class="w-full p-4 border-2 border-gray-200 rounded-xl text-base outline-none focus:border-yellow-400 font-mono text-sm">
            </div>
            <div class="flex gap-2 mb-4">
                <button onclick="testConnection()" id="testConnBtn" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-3 rounded-xl text-sm transition">
                    <i class="fas fa-plug"></i> Tester Connexion
                </button>
                <button onclick="clearKey()" class="bg-red-100 hover:bg-red-200 text-red-500 font-bold py-3 px-4 rounded-xl text-sm transition">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
            <button onclick="saveApiKey()" class="w-full bg-yellow-400 text-white font-bold py-4 rounded-xl text-lg shadow-md active:scale-95 transition-transform">Sauvegarder</button>
            <div id="testResult" class="mt-4 text-xs text-center font-mono break-all hidden p-2 rounded bg-gray-100"></div>
        </div>
    </div>

    <!-- En-tête -->
    <header class="sticky top-0 bg-white/90 backdrop-blur-sm z-40 shadow-sm px-4 py-3 flex justify-between items-center">
        <div class="flex items-center gap-2">
            <i class="fas fa-robot text-red-500 text-2xl"></i>
            <h1 class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-red-500 to-yellow-500">JeSuisUnJouet</h1>
        </div>
        <button onclick="showConfig()" class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center text-gray-500 hover:bg-gray-200">
            <i class="fas fa-cog"></i>
        </button>
    </header>

    <main class="container mx-auto px-4 py-6 max-w-md">
        
        <!-- Zone Upload -->
        <div class="bg-white rounded-3xl shadow-lg p-6 mb-8 border-b-8 border-red-400">
            <div class="flex flex-col gap-6">
                <!-- Prévisualisation Photo -->
                <div class="aspect-square w-full bg-gray-50 rounded-2xl border-4 border-dashed border-gray-200 flex items-center justify-center relative overflow-hidden group" onclick="document.getElementById('fileInput').click()">
                    <img id="sourceImage" class="w-full h-full object-cover hidden z-10">
                    <div id="uploadPlaceholder" class="text-center text-gray-400 z-0">
                        <i class="fas fa-camera text-4xl mb-2 text-gray-300"></i>
                        <p class="text-sm font-semibold">Toucher pour ajouter</p>
                    </div>
                </div>

                <!-- Boutons Actions -->
                <div class="flex flex-col gap-3">
                    <input type="file" id="fileInput" accept="image/*" class="hidden" onchange="handleFileSelect(event)">
                    
                    <button id="generateBtn" onclick="generateAllToys()" disabled class="w-full py-4 rounded-xl font-bold text-lg shadow-md transition-all flex items-center justify-center gap-2 bg-gray-200 text-gray-400 cursor-not-allowed">
                        <i class="fas fa-magic"></i> 
                        <span>Fabriquer les Jouets</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Zone Résultats -->
        <div id="resultsSection" class="hidden animate-fade-in">
            <div id="captureZone" class="bg-[#fdf6e3] rounded-xl p-2 mb-6">
                <h2 class="text-2xl font-bold text-center mb-6 text-gray-700">Ma Collection</h2>
                <div class="grid grid-cols-2 gap-4" id="toysGrid"></div>
                <div class="text-center text-[10px] text-gray-400 mt-4 hidden" id="captureWatermark">Généré par JeSuisUnJouet</div>
            </div>

            <!-- Actions Finales -->
            <div class="flex flex-col gap-4 mt-8">
                <button onclick="downloadCapture()" id="captureBtn" class="w-full bg-green-500 active:bg-green-600 text-white font-bold py-4 rounded-xl shadow-lg flex items-center justify-center gap-3 text-lg transition-transform active:scale-95">
                    <i class="fas fa-image"></i> Sauver Image (JPG)
                </button>
                <button onclick="downloadPDF()" id="pdfBtn" class="w-full bg-red-500 active:bg-red-600 text-white font-bold py-4 rounded-xl shadow-lg flex items-center justify-center gap-3 text-lg transition-transform active:scale-95">
                    <i class="fas fa-file-pdf"></i> Télécharger PDF
                </button>
            </div>
        </div>
    </main>

    <script type="module">
        import { GoogleGenerativeAI } from "@google/generative-ai";

        let uploadedImageBase64 = null;
        let apiKey = localStorage.getItem('gemini_api_key') || '';

        const toyStyles = [
            { id: 'wood', name: 'Bois Vintage', icon: 'fa-tree', color: 'border-yellow-600', prompt: "Turn this person into a vintage hand-carved wooden toy figure. Natural wood grain texture, simple painted details, rustic." },
            { id: 'manga', name: 'Manga', icon: 'fa-book-open', color: 'border-indigo-500', prompt: "Turn this person into a Manga magazine cover character. Anime style, vibrant colors, japanese text." },
            { id: 'barbie', name: 'Poupée Box', icon: 'fa-female', color: 'border-pink-400', prompt: "Turn this person into a plastic fashion doll inside a pink toy box. Barbie style, plastic texture." },
            { id: 'playmobil', name: 'Play-Mibil', icon: 'fa-smile', color: 'border-blue-600', prompt: "Turn this person into a Playmobil figure. Round plastic head, stiff hair, no nose, smiley face." },
            { id: 'vinyl', name: 'Pop Art', icon: 'fa-user-circle', color: 'border-purple-500', prompt: "Turn this person into a vinyl designer toy with a big head. Funko Pop style, smooth plastic." },
            { id: 'clay', name: 'Pâte à modeler', icon: 'fa-hand-rock', color: 'border-green-400', prompt: "Claymation character made of plasticine, fingerprints visible, stop-motion look." },
            { id: 'plush', name: 'Peluche', icon: 'fa-couch', color: 'border-orange-400', prompt: "Soft felt plushie doll. Knitted wool texture, button eyes, stitching visible." },
            { id: 'action', name: 'Action Man', icon: 'fa-fist-raised', color: 'border-red-600', prompt: "Vintage 80s plastic action figure. Muscular, stiff pose, plastic sheen." }
        ];

        // --- RESIZE IMAGE (ENCORE PLUS PETIT = PLUS SÛR) ---
        function resizeImage(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        const MAX_SIZE = 512; 

                        if (width > height) {
                            if (width > MAX_SIZE) { height *= MAX_SIZE / width; width = MAX_SIZE; }
                        } else {
                            if (height > MAX_SIZE) { width *= MAX_SIZE / height; height = MAX_SIZE; }
                        }

                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        resolve(canvas.toDataURL('image/jpeg', 0.6)); 
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        function triggerDownload(blob, filename) {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            setTimeout(() => { document.body.removeChild(a); window.URL.revokeObjectURL(url); }, 100);
        }

        window.initGrid = () => {
            const grid = document.getElementById('toysGrid');
            grid.innerHTML = '';
            toyStyles.forEach(style => {
                const card = document.createElement('div');
                card.className = `toy-card border-b-4 ${style.color}`;
                card.innerHTML = `
                    <div class="card-image-wrapper">
                        <div class="card-image-content bg-gray-100" id="container-${style.id}">
                            <div class="text-center text-gray-300" id="placeholder-${style.id}">
                                <i class="fas ${style.icon} text-3xl mb-1"></i>
                                <p class="text-[10px] uppercase font-bold tracking-wider">${style.name}</p>
                            </div>
                        </div>
                    </div>
                    <div class="p-3 flex justify-between items-center bg-white h-12">
                        <span class="font-bold text-xs text-gray-600 truncate mr-2">${style.name}</span>
                        <button onclick="downloadSingle('${style.id}')" disabled id="btn-${style.id}" class="text-gray-300 hover:text-blue-500 disabled:opacity-30">
                            <i class="fas fa-download"></i>
                        </button>
                    </div>
                `;
                grid.appendChild(card);
            });
        };

        window.handleFileSelect = async (event) => {
            const file = event.target.files[0];
            if (!file) return;

            document.getElementById('uploadPlaceholder').innerHTML = '<i class="fas fa-spinner fa-spin text-2xl"></i>';
            uploadedImageBase64 = await resizeImage(file);
            document.getElementById('sourceImage').src = uploadedImageBase64;
            document.getElementById('sourceImage').classList.remove('hidden');
            document.getElementById('uploadPlaceholder').classList.add('hidden');
            
            const btn = document.getElementById('generateBtn');
            btn.disabled = false;
            btn.classList.remove('bg-gray-200', 'text-gray-400', 'cursor-not-allowed');
            btn.classList.add('bg-blue-500', 'text-white', 'hover:bg-blue-600', 'active:bg-blue-700');
            
            window.initGrid();
            document.getElementById('resultsSection').classList.remove('hidden');
            setTimeout(() => { btn.scrollIntoView({ behavior: 'smooth', block: 'center' }); }, 300);
        };

        window.generateAllToys = async () => {
            if (!uploadedImageBase64) { alert("Ajoutez une photo !"); return; }
            if (!apiKey) { document.getElementById('apiKeyModal').classList.remove('hidden'); return; }

            const btn = document.getElementById('generateBtn');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Fabrication...';

            const genAI = new GoogleGenerativeAI(apiKey);
            const model = genAI.getGenerativeModel({ model: "gemini-2.5-flash-image-preview" });

            for (const style of toyStyles) {
                await generateSingleToy(model, style);
            }
            
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-check"></i> Terminé !';
            setTimeout(() => { btn.innerHTML = originalText; }, 3000);
        };

        async function generateSingleToy(model, style) {
            const container = document.getElementById(`container-${style.id}`);
            if(container) container.innerHTML = '<div class="loader"></div>';

            try {
                if (!uploadedImageBase64) throw new Error("Image non chargée");
                const base64Data = uploadedImageBase64.split(',')[1];

                const result = await model.generateContent({
                    contents: [{ parts: [{ text: style.prompt }, { inlineData: { mimeType: "image/jpeg", data: base64Data } }] }],
                    generationConfig: { responseModalities: ["IMAGE"] }
                });
                
                const candidate = result.response.candidates?.[0];
                const imgPart = candidate?.content?.parts?.find(p => p.inlineData);
                
                if(imgPart) {
                    const src = `data:${imgPart.inlineData.mimeType};base64,${imgPart.inlineData.data}`;
                    container.innerHTML = `<img src="${src}" id="img-${style.id}" alt="${style.name}" class="animate-fade-in" style="width:100%; height:100%; object-fit:cover;">`;
                    const btn = document.getElementById(`btn-${style.id}`);
                    if(btn) { btn.disabled = false; btn.classList.replace('text-gray-300', 'text-blue-500'); }
                    return;
                }
                throw new Error("Pas d'image (Refus IA)");

            } catch (error) {
                console.error("Erreur " + style.name, error);
                
                // --- DIAGNOSTIC PRECIS ---
                let reason = "Erreur inconnue";
                let details = "";

                // Extraction des détails cachés de Google (ce que vous voyiez en 'Array(2)')
                if (error.errorDetails && Array.isArray(error.errorDetails)) {
                     const detailObj = error.errorDetails.find(d => d.reason);
                     if(detailObj) reason = detailObj.reason; // ex: API_KEY_INVALID
                     
                     const msgObj = error.errorDetails.find(d => d.message);
                     if(msgObj) details = msgObj.message;
                } else if (error.message) {
                    reason = error.message;
                }

                // Traduction pour l'utilisateur
                let userMsg = reason;
                if(reason.includes("API_KEY_INVALID")) userMsg = "CLÉ INVALIDE";
                if(reason.includes("PERMISSION_DENIED")) userMsg = "PERMISSION REFUSÉE";
                
                container.innerHTML = `
                    <div class="flex flex-col items-center justify-center p-2 text-center h-full w-full bg-red-50 text-red-500 overflow-hidden">
                        <i class="fas fa-exclamation-circle text-lg mb-1"></i>
                        <span class="text-[10px] font-bold text-red-600">${userMsg}</span>
                        <span class="text-[8px] leading-tight mt-1 opacity-70">${details.substring(0, 50)}</span>
                    </div>`;
            }
        }
        
        // --- FONCTIONS CLÉ API ---
        window.saveApiKey = () => {
            const input = document.getElementById('userApiKey');
            // NETTOYAGE AGRESSIF : On ne garde que les lettres, chiffres et tirets. Adieu les espaces cachés !
            const cleanKey = input.value.replace(/[^a-zA-Z0-9_\-]/g, '');
            
            if (!cleanKey.startsWith('AIza')) {
                alert("Erreur: Une clé Google doit commencer par 'AIza'.");
                return;
            }

            localStorage.setItem('gemini_api_key', cleanKey);
            apiKey = cleanKey;
            document.getElementById('apiKeyModal').classList.add('hidden');
            if(uploadedImageBase64) window.generateAllToys();
        };

        window.clearKey = () => {
            localStorage.removeItem('gemini_api_key');
            apiKey = '';
            document.getElementById('userApiKey').value = '';
            alert("Clé supprimée. Collez la nouvelle.");
        };

        window.testConnection = async () => {
            const input = document.getElementById('userApiKey');
            const keyToTest = input.value.replace(/[^a-zA-Z0-9_\-]/g, '');
            const resDiv = document.getElementById('testResult');
            const btn = document.getElementById('testConnBtn');
            
            if(!keyToTest) { alert("Entrez une clé d'abord"); return; }
            
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Test...';
            resDiv.classList.remove('hidden');
            resDiv.innerHTML = "Tentative de connexion...";
            
            try {
                // Test simple TEXTE pour valider la clé (modèle standard)
                const genAI = new GoogleGenerativeAI(keyToTest);
                const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });
                const result = await model.generateContent("Hello");
                const response = await result.response;
                const text = response.text();
                
                resDiv.className = "mt-4 text-xs text-center font-bold p-2 rounded bg-green-100 text-green-700";
                resDiv.innerHTML = `<i class="fas fa-check"></i> CLÉ VALIDE !<br>Google répond: "${text.substring(0,10)}..."`;
                btn.innerHTML = '<i class="fas fa-check"></i> Succès';
                btn.classList.add('bg-green-200');
            } catch (e) {
                console.error(e);
                let errReason = "Erreur inconnue";
                if(e.errorDetails) errReason = JSON.stringify(e.errorDetails);
                else errReason = e.message;

                resDiv.className = "mt-4 text-xs text-center font-bold p-2 rounded bg-red-100 text-red-700";
                resDiv.innerHTML = `<i class="fas fa-times"></i> ÉCHEC : ${errReason}`;
                btn.innerHTML = '<i class="fas fa-times"></i> Erreur';
                btn.classList.add('bg-red-200');
            }
        };

        window.downloadSingle = (id) => {
            const img = document.getElementById(`img-${id}`);
            if(img) fetch(img.src).then(res => res.blob()).then(blob => triggerDownload(blob, `Jouet-${id}.jpg`));
        };

        window.downloadCapture = () => {
            const btn = document.getElementById('captureBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '...'; btn.disabled = true;
            document.getElementById('captureWatermark').classList.remove('hidden');

            html2canvas(document.getElementById('captureZone'), {
                scale: 1.5, useCORS: true, backgroundColor: '#fdf6e3', logging: false
            }).then(canvas => {
                canvas.toBlob(blob => {
                    triggerDownload(blob, 'MaCollection.jpg');
                    btn.innerHTML = originalText; btn.disabled = false;
                    document.getElementById('captureWatermark').classList.add('hidden');
                }, 'image/jpeg', 0.85);
            }).catch(e => { alert("Erreur Capture Mobile"); btn.innerHTML = originalText; btn.disabled = false; });
        };

        window.downloadPDF = () => {
            const btn = document.getElementById('pdfBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '...'; btn.disabled = true;
            setTimeout(() => {
                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    doc.setFontSize(20); doc.setTextColor(220, 50, 50);
                    doc.text("Ma Collection", 105, 20, null, null, "center");
                    let y = 40; let count = 0;
                    toyStyles.forEach((style) => {
                        const img = document.getElementById(`img-${style.id}`);
                        if(img && img.src) {
                            if(y > 250) { doc.addPage(); y = 20; }
                            doc.addImage(img.src, 'JPEG', 20, y, 60, 60);
                            doc.setFontSize(12); doc.setTextColor(50,50,50);
                            doc.text(style.name, 90, y + 30);
                            y += 70; count++;
                        }
                    });
                    if(count > 0) doc.save("CollectionJouets.pdf");
                    else alert("Aucune image à imprimer !");
                } catch(e) { alert("Erreur PDF Mobile"); }
                finally { btn.innerHTML = originalText; btn.disabled = false; }
            }, 100);
        };
        
        window.showConfig = () => {
             const modal = document.getElementById('apiKeyModal');
             modal.classList.remove('hidden');
             document.getElementById('userApiKey').value = apiKey;
             document.getElementById('testResult').classList.add('hidden');
        };
        
        window.initGrid();
    </script>
</body>
</html>
